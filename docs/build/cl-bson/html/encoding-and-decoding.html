<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
  Encoding and decoding &ndash; cl-bson
</title>
    <link rel="stylesheet" href="static/style.css"/>
    
  <link rel="stylesheet" href="static/highlight.css"/>
  <script src="static/highlight.js"></script>

  </head>
  <body>
    
  <h1 class="doc-title">cl-bson Â» Encoding and decoding</h1>
  <article>
    <aside>
      <ol class="toc"><li><a href="api.html">API</a></li><li><a href="bson-types.html">BSON Types</a></li><li><a href="encoding-and-decoding.html">Encoding and decoding</a></li><li><a href="readtable.html">Readtable</a></li></ol>
    </aside>
    <main class="codex-section">
      <h1 id="encoding">Encoding</h1><div class="codex-doc-node codex-operator codex-generic-function"><code class="codex-name">encode</code><code class="codex-lambda-list">(document)</code><div class="codex-docstring">Encodes a given <code class="codex-param">document</code> into an <code>octets-array</code> following the <a href="http://bsonspec.org/spec.html">BSON specification</a>.</div></div><div class="codex-doc-node codex-operator codex-generic-function"><code class="codex-name">encode-key-value</code><code class="codex-lambda-list">(key value)</code><div class="codex-docstring"><p>Main helper generic function for doing the actual work of encoding <code class="codex-param">key</code><code class="codex-param">value</code> pairs. Most of the method implementations have the following skeleton:</p><pre><code class="lisp">(defmethod encode-key-value (key (value SOME-TYPE))
  ;; Writes the BSON-BYTE-SPECIFIER
  (fast-write-byte BSON-BYTE-SPECIFIER *bson-out*)
  ;; Encodes the key string in C-style
  (encode-cstring key)
  ;; Encodes the value with a custom function
  (encode-the-value-somehow value))</code></pre><p></p><p>In general, the functions relative to <code>encode-the-value-somehow</code> converts the <code class="codex-param">value</code> into an <code>octets-array</code> and then call <code>#'fast-io:fast-write-sequence</code>.</p></div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">encode-document</code><code class="codex-lambda-list">(elements)</code><div class="codex-docstring">Goes through all the elements of the <code class="codex-param">elements</code> hash-table using <a href="http://l1sp.org/cl/maphash"><code>maphash</code></a> and encode the <code>key</code><code>value</code> pairs with <code>#'encode-key-value</code>, writing to the bound <code>*bson-out*</code>.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">encode-cstring</code><code class="codex-lambda-list">(value)</code><div class="codex-docstring">Coerces <code class="codex-param">value</code> to string using the <a href="http://l1sp.org/cl/string"><code>string</code></a> function and transforms it to an <code>octets-array</code> using <code>(babel:string-to-octets (string value) :encoding :utf-8)</code>.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">encode-string</code><code class="codex-lambda-list">(value)</code><div class="codex-docstring">Encodes a given <code class="codex-param">value</code> into an array with 4 bytes for length, the string <code class="codex-param">value</code> encoded with <code>(string-to-octets value :encoding :utf-8)</code> and a null byte (0) at the end.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">encode-document-array</code><code class="codex-lambda-list">(key value)</code><div class="codex-docstring">Gets <code class="codex-param">value</code> sequence and encodes it as a document. Each element gets a index as a key to create the document.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">encode-boolean</code><code class="codex-lambda-list">(key value)</code><div class="codex-docstring">Encodes the given boolean <code class="codex-param">value</code>. Since Common Lisp doesn't differenciate 'false' values from 'null' values, any null value gets 'encoded' as a boolean <a href="http://l1sp.org/cl/nil"><code>nil</code></a>.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">encode-int32</code><code class="codex-lambda-list">(key value)</code><div class="codex-docstring">Encodes the given <code class="codex-param">value</code> as a 4 bytes <code>octets-array</code> sequence.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">encode-int64</code><code class="codex-lambda-list">(key value)</code><div class="codex-docstring">Encodes the given value as a 8 bytes <code>octets-array</code> sequence.</div></div><h1 id="decoding">Decoding</h1><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">decode</code><code class="codex-lambda-list">(octets-array)</code><div class="codex-docstring">Main entry point to decode a given array. It performs the first binding of <code>*doc-out*</code> and call <code>#'decode-document</code>.</div></div><div class="codex-doc-node codex-variable"><code class="codex-name">*bson-in*</code><div class="codex-docstring">Special var that gets bound to <code>fast-io:input-buffer</code> on every <code>#'decode</code> call. Many of the <code>#'decode-*</code> functions read from <code>*bson-in*</code>(destructively) and returns the value to be added to <code>*doc-out*</code>.</div></div><div class="codex-doc-node codex-variable"><code class="codex-name">*doc-out*</code><div class="codex-docstring">Special variable that holds the current <code>&lt;document&gt;</code> on every <code>#'decode-document</code> call.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">decode-key-value</code><code class="codex-lambda-list">nil</code><div class="codex-docstring">Main function that dispatches to the correct <code>#'decode-*</code> function. It first decodes the element type, than dispatches to the function that decodes the value type and finally adds the decoded <code>key</code><code>value</code> pair to <code>*doc-out*</code>. If it finds an invalid element type, it throws an <a href="http://l1sp.org/cl/error"><code>error</code></a>.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">decode-timestamp</code><code class="codex-lambda-list">nil</code><div class="codex-docstring">Decodes a <a href="https://common-lisp.net/project/local-time/manual.html#Types"><code>local-time:timestamp</code></a> with milliseconds precision.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">decode-sequence</code><code class="codex-lambda-list">nil</code><div class="codex-docstring">Decodes a <code>&lt;document&gt;</code> and extract only the values. Depending on the value of <code>*bson-sequence-type</code>, returns the values as a list or as a vector.</div></div><div class="codex-doc-node codex-variable"><code class="codex-name">*bson-sequence-type*</code><div class="codex-docstring">Special variable that holds the kind of output to return when decoding a BSON array.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">decode-binary</code><code class="codex-lambda-list">nil</code><div class="codex-docstring">Reads an <code>octets-array</code> and instanciates a <code>&lt;binary-data&gt;</code> object with the read data.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">decode-javascript</code><code class="codex-lambda-list">nil</code><div class="codex-docstring">Decodes a string from <code>*bson-in*</code> and creates an instance of <code>&lt;javascript&gt;</code>.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">decode-javascript-w/scope</code><code class="codex-lambda-list">nil</code><div class="codex-docstring">Decodes a string and a <code>&lt;document&gt;</code> from <code>*bson-in*</code> and creates an instance of <code>&lt;javascript&gt;</code> with the <code>scope</code> field bound to the decoded <code>&lt;document&gt;</code>.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">decode-regex</code><code class="codex-lambda-list">nil</code><div class="codex-docstring">Decodes 2 strings with <code>#'decode-cstring</code> and creates an instance of <code>&lt;regex&gt;</code>.</div></div><div class="codex-doc-node codex-operator codex-function"><code class="codex-name">decode-document</code><code class="codex-lambda-list">nil</code><div class="codex-docstring">Binds <code>*doc-out*</code> to a new document and call <code>#'decode-key-value</code> to decode values withing the new bound <code>*doc-out*</code>. Returns the decoded <code>*doc-out*</code><code>&lt;document&gt;</code>.</div></div>
    </main>
  </article>
  <footer>
    <div class="info">
      Created with <a href="https://github.com/CommonDoc/codex">Codex</a>.
    </div>
  </footer>
  <script>
   HighlightLisp.highlight_auto();
  </script>

  </body>
</html>
